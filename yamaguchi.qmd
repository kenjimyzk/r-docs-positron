---
title: "Yamaguchi 回帰分析"
format: 
    html:
      toc: true
      toc-depth: 2
      number-sections: true
    docx: default 
    pdf:
     pdf-engine: lualatex
     documentclass: ltjsarticle
     classoption: lualatex,ja=standard
execute: 
  warning: false
  message: false
knitr:
  opts_chunk:
    comment: "#>"
    collapse: true
---

## データの読み込みと整形

このドキュメントでは、西山慶彦・新谷元嗣・川口大司・奥井亮 (2019)『計量経済学』有斐閣の**第6章「パネルデータ分析」**で紹介されている実証例を再現します。

分析テーマは、**既婚女性の労働供給**に関するパネルデータを用いて、**保育所の整備（資本率: cap.rate）が女性の雇用率（emp.rate）に与える影響**を検証することです。これは労働経済学や公共政策の分野で重要なテーマであり、「保育所が増えると女性の就業率は上がるのか？」という因果関係を検証する実証分析の一例です。データは山口（2009）に基づいています。

ここでは `yamaguchi.csv` を読み込み、2000年以降かつ世帯タイプが `all` の観測だけを残したデータを使って、雇用率と資本率の関係を検討します。

```{r}
# データ読み込みと確認
yamaguchi <- read.csv("yamaguchi.csv")
head(yamaguchi)

yamaguchi <- subset(yamaguchi, year > 1999 & hh.type == "all")
head(yamaguchi)
```


## モデル定義と概要

パネルデータ分析では、**固定効果（fixed effects）**を導入することで、観察できない個体差や時点差をコントロールできます。以下では単純なOLSから、クラスタリングや固定効果を導入したモデル、加えて制御変数を含むモデルまで段階的に推定します。それぞれのモデルは表で比較します。

### estimatr パッケージのインストールと読み込み

`estimatr` パッケージは、頑健な標準誤差（ロバスト標準誤差）やクラスター標準誤差を簡単に計算できるパッケージです。`lm_robust()` 関数を使うことで、クロスセクション分析だけでなく、今回のようなパネルデータ分析においても、固定効果モデルやクラスタリングを含む回帰分析を効率的に実行できます。

主な機能：

- **lm_robust()**：頑健標準誤差付きの線形回帰
- **se_type**：標準誤差の種類を指定（"stata" は Stata と同じ HC1 タイプ）
- **clusters**：クラスター標準誤差の計算
- **fixed_effects**：固定効果の指定（ダミー変数を明示的に作らなくてよい）

```{r}
library(estimatr)
```

**ポイント**：

- **クラスター標準誤差**：都道府県内で誤差が相関している可能性があるため、都道府県でクラスタリングして標準誤差を計算します。
- **固定効果**：都道府県固定効果は「各県固有の特性」を、年固定効果は「全国共通のマクロショック」をコントロールします。

### モデル1: 単純OLS（固定効果なし）

まずは固定効果を入れない単純な回帰から始めます。

```{r}
# モデル1: 単純OLS
fm1 <- lm_robust(emp.rate ~ cap.rate, 
    data = yamaguchi, se_type = "stata")
summary(fm1)
```

**結果の解釈**：cap.rate の係数は約 **0.615** で、1%水準で有意です。これは「資本率（保育所整備率）が1ポイント上がると、雇用率が約0.615ポイント上がる」という正の相関を示しています。ただし、この段階では因果関係とは言えません。

### モデル2: 都道府県固定効果

```{r}
# モデル2: クラスタリングと都道府県固定効果
fm2 <- lm_robust(
  emp.rate ~ cap.rate,
  data = yamaguchi,
  se_type = "stata",
  clusters = pref,
  fixed_effects = pref
)
summary(fm2)
```

**結果の解釈**：都道府県固定効果を入れると、cap.rate の係数は約 **0.805** に上昇し、依然として1%水準で有意です。これは各県固有の特性（産業構造、文化など）をコントロールした上でも、保育所整備と雇用率の間に強い正の関係があることを示しています。

### モデル3: 年固定効果

```{r}
# モデル3: 年の固定効果
fm3 <- lm_robust(
  emp.rate ~ cap.rate,
  data = yamaguchi,
  se_type = "stata",
  clusters = pref,
  fixed_effects = year
)
summary(fm3)
```

**結果の解釈**：年固定効果のみを入れた場合、cap.rate の係数は約 **0.585** で有意です。全国共通の時間トレンド（景気変動など）を除去しても正の関係が残っています。

### モデル4: 都道府県 + 年 の二元固定効果（Two-way FE）

```{r}
# モデル4: 都道府県 + 年 の固定効果
fm4 <- lm_robust(
  emp.rate ~ cap.rate,
  data = yamaguchi,
  se_type = "stata",
  clusters = pref,
  fixed_effects = pref + year
)
summary(fm4)
```

**結果の解釈（重要！）**：都道府県と年の両方の固定効果を入れると、cap.rate の係数は約 **0.090** に大幅に低下し、**統計的に有意ではなくなります**（p値 = 0.226）。これは非常に重要な発見です。

**なぜ係数が小さくなったのか？**  
都道府県固定効果は「県ごとの平均的な違い」を、年固定効果は「全国共通の時間変化」を吸収します。両方を入れると、「ある県で、ある年に、他の県や年と比べて保育所が増えたとき、雇用率がどう変わるか」という、より厳密な因果関係に近い推定になります。その結果、単純なOLSで見られた強い正の相関の多くは、実は県固有の特性や全国的なトレンドによるものだった可能性があります。

### モデル5: 制御変数を追加（年固定効果）

```{r}
# モデル5: 制御変数を追加（年固定効果）
fm5 <- lm_robust(
  emp.rate ~ cap.rate + age + age.hus + emp.rate.hus + urate,
  data = yamaguchi,
  se_type = "stata",
  clusters = pref,
  fixed_effects = year
)
summary(fm5)
```

**結果の解釈**：年固定効果に加えて、妻の年齢（age）、夫の年齢（age.hus）、夫の雇用率（emp.rate.hus）、失業率（urate）を制御変数として追加しました。cap.rate の係数は約 **0.535** で依然として有意です。制御変数を加えてもなお正の効果が確認されます。

### モデル6: 制御変数を追加（二元固定効果）

```{r}
# モデル6: 制御変数を追加（都道府県+年 固定効果）
fm6 <- lm_robust(
  emp.rate ~ cap.rate + age + age.hus + emp.rate.hus + urate,
  data = yamaguchi,
  se_type = "stata",
  clusters = pref,
  fixed_effects = pref + year
)
summary(fm6)
```

**結果の解釈**：二元固定効果に制御変数を加えたモデルでは、cap.rate の係数は約 **0.114** で、やはり**有意ではありません**（p値 = 0.126）。一方、失業率（urate）は係数 **-0.661** で5%水準で有意です。これは「失業率が高い地域・時期ほど女性の雇用率が低い」という直感に合った結果です。

## modelsummary パッケージのインストールと読み込み

`modelsummary` パッケージは、回帰分析の結果を見やすい表形式で出力するためのツールです。複数のモデルを横に並べて比較したり、記述統計を作成したりできます。論文やレポートで使える高品質な表を簡単に作成できるため、実証分析では非常に便利です。

主な機能：

- **modelsummary()**：複数の回帰モデルを1つの表にまとめて比較
- **datasummary()**：記述統計表の作成
- **coef_omit / gof_omit**：不要な係数や適合度指標を非表示にするオプション

```{r}
library(modelsummary)
```

### 記述統計（主要変数）

分析に使用する主要変数（雇用率・資本率・年齢など）の記述統計を示します。141の観測値（47都道府県 × 3年）があります。

- **emp.rate（雇用率）**：平均 0.431、標準偏差 0.097。既婚女性の約43%が就業しています。
- **cap.rate（資本率）**：平均 0.363、標準偏差 0.115。保育所の整備状況を表します。
- **urate（失業率）**：平均 0.057（5.7%）。地域の労働市場の状況を反映します。

```{r}
library(tidyverse)
vars <- yamaguchi %>%
  select(emp.rate, cap.rate, age, age.hus, emp.rate.hus, urate)

table63 <- datasummary(
  All(vars) ~ N + Mean + SD + Min + Max,
  data = yamaguchi,
  fmt = 3
)
table63
```

```{r}

table64 <- datasummary(emp.rate * (Mean + SD) + cap.rate * (Mean + SD) ~ factor(year),
            data = yamaguchi,
            fmt = 3)
table64

```

### 回帰結果の表（定数項を表示しない）
下の表は6つのモデルを横に並べて比較したものです。`coef_omit` により定数項（Intercept）は表示していません。

```{r}
library(modelsummary)
models <- list()
models[["(1)"]] <- fm1
models[["(2)"]] <- fm2
models[["(3)"]] <- fm3
models[["(4)"]] <- fm4
models[["(5)"]] <- fm5
models[["(6)"]] <- fm6

table65<-modelsummary(
  models,
  stars = c(`***` = 0.01, `**` = 0.05, `*` = 0.1),
  gof_omit = "IC|Log|AIC|BIC|RMSE|Within|Pseudo|Std.Errors",
  coef_omit = "\\(Intercept\\)",
  fmt = 3
)
table65
```

## 簡単な解釈

### 分析結果のまとめ

| モデル | cap.rate係数 | 有意性 | 固定効果 |
|--------|--------------|--------|----------|
| (1) 単純OLS | 0.615 | *** | なし |
| (2) 県FE | 0.805 | *** | 都道府県 |
| (3) 年FE | 0.585 | *** | 年 |
| (4) 二元FE | 0.090 | n.s. | 都道府県+年 |
| (5) 年FE+制御変数 | 0.535 | *** | 年 |
| (6) 二元FE+制御変数 | 0.114 | n.s. | 都道府県+年 |

### 教育的ポイント

1. **固定効果の重要性**：単純なOLSでは強い正の相関（0.615）が見られますが、二元固定効果を入れると効果は消えます（0.090、有意でない）。これは「見かけの相関」と「因果関係」の違いを示す好例です。

2. **欠落変数バイアス（Omitted Variable Bias）**：県の特性や時間トレンドをコントロールしないと、推定にバイアスが生じます。例えば、「女性の就業意欲が高い県は保育所も充実している」という場合、保育所の効果を過大評価してしまいます。

3. **クラスター標準誤差**：パネルデータでは同一個体（ここでは都道府県）内で誤差が相関している可能性があるため、クラスター頑健標準誤差を使うことが重要です。

4. **政策的含意**：この分析結果だけでは「保育所を増やしても女性の就業率は上がらない」とは結論づけられません。二元固定効果モデルは非常に厳しい条件での推定であり、効果がゼロというよりも「このデータ・手法では検出できなかった」という解釈が適切です。

(注) 出力の形式や不要な係数をさらに除外したい場合は、`modelsummary()` の `coef_map` や `coef_omit` に正規表現を渡して調整してください。
