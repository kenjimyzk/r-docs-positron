---
title: "R使い方入門：パネルデータ分析と差の差法（DID）の実践"
format: 
    html:
      toc: true
      toc-depth: 2
      number-sections: true
    docx: default 
    pdf:
     pdf-engine: lualatex
     documentclass: ltjsarticle
     classoption: lualatex,ja=standard
execute: 
  warning: false
  message: false
knitr:
  opts_chunk:
    comment: "#>"
    collapse: true
---


## データの読み込みと概要

分析テーマは、**健康ショック（shock）が生活満足度（life）に与える影響**を、パネルデータを用いて検証することです。ここでは**差の差法（Difference-in-Differences: DID）**と呼ばれる手法を用いて、処置（健康ショック）の因果効果を識別します。

### データの説明

- **id**: 個人識別番号
- **t**: 時点（1 = 処置前、2 = 処置後）
- **life**: 生活満足度（0〜4の5段階）
- **shock**: 健康ショックを受けたグループかどうか（1 = 処置群、0 = 対照群）
- **y2**: 時点ダミー（1 = 2期目、0 = 1期目）
- **shock_y2**: 処置群×2期目の交差項（DIDの識別変数）
- **income**: 所得（制御変数）

```{r}
# データ読み込みと確認
life9 <- read.csv("9_2_life_xt.csv")
head(life9)
```

データ構造を確認します。

```{r}
str(life9)
```

サンプルサイズを確認します。

```{r}
# 個人数と観測数
n_individuals <- length(unique(life9$id))
n_obs <- nrow(life9)
cat("個人数:", n_individuals, "\n")
cat("総観測数:", n_obs, "\n")
cat("1人あたり観測数:", n_obs / n_individuals, "\n")
```

## 差の差法（DID）の考え方

### DIDとは何か？

差の差法（Difference-in-Differences）は、**処置群と対照群の変化の差**を比較することで、処置の因果効果を識別する手法です。

**基本的なアイデア**：

1. 処置群の変化（2期目 − 1期目）を計算
2. 対照群の変化（2期目 − 1期目）を計算
3. 両者の差を取る → これがDID推定量

**なぜ「差の差」なのか？**

単純に処置群と対照群を比較するだけでは、両グループのもともとの違い（セレクションバイアス）を除去できません。また、単純に前後比較するだけでは、時間とともに変化する共通のトレンド（時間効果）を除去できません。

DIDは「差を取る」ことを2回行うことで、個人固有の効果と時間効果の両方を除去し、処置の純粋な効果を識別します。

### DID推定のための回帰モデル

DIDは以下の回帰式で表現できます：

$$
life_{it} = \alpha + \beta \cdot shock_i + \gamma \cdot y2_t + \delta \cdot (shock_i \times y2_t) + \varepsilon_{it}
$$

- $\beta$：処置群と対照群のベースラインの差
- $\gamma$：時間効果（全員に共通する2期目の変化）
- $\delta$：**DID推定量**（処置の因果効果）

**$\delta$ の解釈**：処置群が2期目に受けた追加的な効果、つまり健康ショックの因果効果です。

## plm パッケージによるパネルデータ分析

### plm パッケージのインストールと読み込み

`plm` パッケージは、パネルデータ分析のための標準的なRパッケージです。固定効果モデル、変量効果モデル、1階差分法など、さまざまなパネルデータ推定法を提供します。

主な機能：

- **plm()**：パネルデータ回帰の推定
- **model**：推定方法の指定（"pooling", "within", "random", "fd"など）
- **effect**：固定効果の種類（"individual", "time", "twoways"）
- **pFtest(), phtest()**：モデル選択のための検定

```{r}
library(plm)
```

### モデル1: 1階差分法（First Difference）

1階差分法は、各個人の2時点間の差を取ることで、時間不変の個人固有効果を除去する方法です。

$$
\Delta life_i = life_{i2} - life_{i1} = \gamma + \delta \cdot shock_i + \Delta income_i + \Delta \varepsilon_i
$$

`plm()` で `model = "fd"` を指定します。

```{r}
# 1階差分法（fd）による回帰
preg_fd <- plm(life ~ shock_y2 + income,
    data = life9,
    effect = "individual",
    model = "fd",
    index = c("id", "t")
)
summary(preg_fd)
```

**結果の解釈**：

- **shock_y2** の係数（約 **-0.140**）がDID推定量です。これは健康ショックを受けた人が2期目に経験した生活満足度への追加的な影響を表します。係数が負であることは、健康ショックが生活満足度を約0.14ポイント低下させることを意味します（1%水準で有意）。
- 1階差分法では、時間不変の個人特性（性格、遺伝的要因など）が自動的に除去されます。

### モデル2: 固定効果モデル（Within推定量）

固定効果モデルは、各個人の平均からの偏差を用いて推定を行います。1階差分法と同様に、時間不変の個人固有効果を除去できます。

```{r}
# 固定効果モデル（within）を用いた回帰
preg_fe <- plm(life ~ shock + y2 + shock_y2 + income,
    data = life9,
    effect = "individual",
    model = "within",
    index = c("id", "t")
)
summary(preg_fe)
```

**結果の解釈**：

- 固定効果モデルでは、`shock` は時間不変なので推定されません（個人固定効果に吸収されます）。
- `y2` の係数（約 **0.215**）は時間効果を表し、`shock_y2`（約 **-0.140**）がDID推定量です。
- 2時点パネルの場合、1階差分法と固定効果モデルは**同じ推定量**を与えます。実際に両モデルで shock_y2 と income の係数が一致していることを確認できます。

### モデル3: プーリングOLS

比較のため、個人固有効果を無視したプーリングOLSも推定します。

```{r}
# プーリングOLSを用いた回帰
preg_p <- plm(life ~ shock + y2 + shock_y2 + income,
    data = life9,
    effect = "individual",
    model = "pooling",
    index = c("id", "t")
)
summary(preg_p)
```

**プーリングOLS vs 固定効果モデル**：

プーリングOLSは個人固有効果を無視するため、もし個人固有効果が説明変数と相関していれば、推定量にバイアスが生じます。

### F検定：固定効果の有意性

固定効果モデルとプーリングOLSのどちらが適切かを検定します。

```{r}
# F検定：固定効果の有意性
pFtest(preg_fe, preg_p)
```

**結果の解釈**：

- 帰無仮説：「すべての個人固定効果がゼロ」（プーリングOLSが適切）
- p値 = 0.011 で5%水準で有意なので、帰無仮説を棄却し、固定効果モデルが適切と判断します。
- 固定効果が有意であれば、個人差を考慮した分析が必要ということになります。

### モデル4: 変量効果モデル

変量効果モデルは、個人固有効果を確率変数として扱います。固定効果モデルより効率的ですが、個人固有効果と説明変数が無相関という強い仮定が必要です。

```{r}
# 変量効果モデル（random）を用いた回帰
preg_re <- plm(life ~ shock + y2 + shock_y2 + income,
    data = life9,
    effect = "individual",
    model = "random",
    index = c("id", "t")
)
summary(preg_re)
```

**固定効果 vs 変量効果の違い**：

両モデルとも個人固有効果 $\alpha_i$ を確率変数として扱いますが、説明変数との相関についての仮定が異なります。

| 特徴 | 固定効果モデル | 変量効果モデル |
|------|----------------|----------------|￥
| $\alpha_i$ と誤差項の相関 | 相関があってもよい | 無相関を仮定 |
| 推定方法 | Within変換（個人平均からの偏差） | GLS（一般化最小二乗法） |
| 効率性 | 低い | 高い（仮定が正しければ） |
| 一致性 | 常に一致推定量 | 無相関の仮定が満たされれば一致 |
| 時間不変変数 | 推定不可（Within変換で消える） | 推定可能 |

**ポイント**：固定効果モデルは「個人効果と説明変数が相関している」という現実的な状況でも一致推定量を与えるため、因果推論ではより頑健です。一方、変量効果モデルは無相関の仮定が正しければより効率的（標準誤差が小さい）な推定が可能です。過去には固定効果を未知の定数、変量効果を確率変数とみなしたが、現在はどちらも確率変数とかんげて、違いは誤差項と相関があるかどうかの仮定が異なるだけです。

### Hausman検定：固定効果 vs 変量効果

どちらのモデルが適切かを検定します。

```{r}
# Hausman検定
phtest(preg_re, preg_fe)
```

**結果の解釈**：

- 帰無仮説：「個人固有効果と説明変数は無相関」（変量効果モデルが適切）
- p値 = 0.965 と非常に大きいため、帰無仮説を棄却できません。この場合、変量効果モデルが適切と判断できます。
- 変量効果モデルは固定効果モデルより効率的なので、Hausman検定で棄却されなければ変量効果モデルを使うことが推奨されます。

## 教育的ポイント

### 1. DIDの識別仮定

DIDが因果効果を正しく識別するためには、**平行トレンド仮定**が必要です：

> 処置がなかった場合、処置群と対照群は同じトレンドで変化していたはず

この仮定が満たされない場合（例：健康ショックを受けやすい人はもともと生活満足度が低下傾向にあった）、DID推定量にはバイアスが生じます。

### 2. 固定効果と1階差分の関係

2時点パネルでは：

- **1階差分法** = **固定効果モデル**（同じ推定量）

3時点以上のパネルでは：

- 誤差項に系列相関がなければ、固定効果モデルの方が効率的
- 誤差項がランダムウォークなら、1階差分法の方が効率的

### 3. モデル選択の指針

1. **pFtest**：固定効果が有意か？ → 有意なら固定効果モデルを使用
2. **phtest**（Hausman検定）：個人効果と説明変数は無相関か？
   - 棄却 → 固定効果モデル
   - 棄却されない → 変量効果モデル（効率性のため）

### 4. 政策評価への応用

DIDは政策評価で広く使われます：

- **例**：ある県で保育所が増設された → 女性の就業率への効果
- **処置群**：保育所が増えた県
- **対照群**：保育所が増えなかった県
- **DID推定量**：政策の因果効果

ただし、政策の実施が無作為でない場合（例：就業意欲が高い県ほど保育所を増やした）、平行トレンド仮定が満たされない可能性があります。

