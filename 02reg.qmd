---
title: "02regression"
format: html
editor: visual
---

## 重回帰分析
### データ読み込み
```{r}
df <- read.csv("6_1_income.csv")
head(df)
```

賃金データをCSVから取り込み、`head()` で主な列（`lincome`, `yeduc`, `exper`, `exper2` など）の値や型をざっと確認して以降の解析に備えます。

### 重回帰分析

`lm()` で学歴・経験年数・経験二乗を同時に投入した基本モデルを推定し、`summary()` で係数推定値、決定係数、p値をまとめて把握します。
```{r}
model1 <- lm(lincome ~ yeduc + exper + exper2, data = df)
summary(model1)
```

### 回帰解剖

説明変数どうしの重なりを可視化するために、まず `yeduc` を他の説明変数で回帰し、その残差を使って `lincome` と結びつける「回帰解剖」を実行します。
```{r}
model10<-lm(yeduc ~ exper+exper2, data = df)
model11<-lm(lincome~residuals(model10), data = df)
summary(model11)
```

### 対数変換

元の `income` を `log()` で対数変換したモデルを別途推定し、スケールを変えることで係数解釈（弾力性）や残差分布がどう変化するかを比較します。
```{r}
model2 <- lm(log(income) ~ yeduc + exper + exper2, data = df)
summary(model2)
```

### 二乗項

`I(exper^2)` を明示的に加えて経験年数の曲線的効果を推定し、事前に作っておいた `exper2` を使うケースとで係数や適合度が一致するかを確認します。
```{r}
model3 <- lm(lincome~ yeduc + exper + I(exper^2), data = df)
summary(model3)
```

### F検定

制約付きモデル (`model0`) と拡張モデル (`model1` / `model3`) のSSRを比較し、`anova()` と手計算の双方でF統計量と臨界値を確認してモデル拡張の有意性を判断します。
```{r}
model0 <- lm(lincome ~ yeduc, data = df)
anova(model0, model1)
ssr1 <- deviance(model3)
ssr0 <- deviance(model0)
k <- model3$rank-model0$rank
f0<-(ssr0-ssr1)/k # numerator
dof <- model3$df.residual
f1<-ssr1/dof # denominator
(fstat<-f0/f1)
qf(0.95, k, dof)
```

## タミー変数

性別を表すダミー変数（female）を導入し、ダミー変数やダミーとの交差項が収入に与える影響を調べます。

### 定数項のみ

女性ダミーを含む新しいデータセットを読み込み、まずは `yeduc` と `female` のみを含むベースライン回帰を推定して、ダミー変数の係数解釈を確認します。
```{r}
df <- read.csv("7_1_income.csv")
head(df)
model1 <- lm(lincome ~ yeduc + female, data=df)
summary(model1)
```

### 交差項の導入

手作業で作成した交差項 `female_yeduc` を投入し、グループごとに学歴の傾きが違うかを直接推定します。
```{r}
model2 <- lm(lincome ~ yeduc + female + female_yeduc, data=df)
summary(model2)
```

### 交差項の別表記

`female:yeduc` を用いた書き方では、同じ交差効果を `:` 演算子で指定しつつ、切片と傾きの水準差をそのまま確認できます。
```{r}
model3 <- lm(lincome ~ yeduc + female + female:yeduc, data=df)
summary(model3)
```
### 交差項の別表記

`yeduc * female` は主効果と交差効果を一括で展開する省略記法なので、同じ結果が得られるかを `model3` と比べてチェックします。
```{r}
model4 <- lm(lincome ~ yeduc * female, data=df)
summary(model4)
```

### F検定

ダミーと交差項を含むモデル (`model4`) がベースライン (`model0`) より統計的に優れているかを `anova()` のF検定で確認します。
```{r}
model0 <- lm(lincome ~ yeduc, data=df)
anova(model0, model4)
```

### チャウ検定

SSRを使ったチャウ検定統計量を手計算で求め、`model0` と `model4` の差異がサブサンプル（性別）間で係数の構造変化を示唆するかを評価します。
```{r}
ssr1 <- deviance(model4)
ssr0 <- deviance(model0)
k <- model4$rank-model0$rank
f0<-(ssr0-ssr1)/k # numerator
dof <- model4$df.residual
f1<-ssr1/dof # denominator
(fstat<-f0/f1)
qf(0.95, k, dof)
```

## 頑健な標準誤差

ホワイト修正やロバスト推定量を使って標準誤差がどの程度安定するかを比較します。以下では分散共分散行列の修正、`estimatr::waldtest`、`lm_robust` など複数のチャンクで手順を分けて示します。

最初は `lmtest` / `sandwich` を用い、通常のOLS推定後に HC1 で分散共分散行列を補正してホワイト修正済みの係数表を得ます。
```{r}

#データの読み込み
income6 <- read.csv("6_1_income.csv")

#ミンサー方程式をOLSで重回帰
reg1 <- lm(lincome ~ yeduc + exper + exper2, data = income6) 
#回帰の結果の確認
summary(reg1)

#頑健な標準誤差を求める（ホワイトの修正）
#必要なパッケージのインストールと読み込み
library(lmtest)
library(sandwich)

#分散共分散行列を計算
vcov <- vcovHC(reg1, type = "HC1")
#重回帰分析の結果とvcovから標準誤差をホワイト修正
coeftest(reg1, vcov)
```

続いて `estimatr::waldtest` に修正済み `vcov` を渡し、制約付きモデルと非制約モデルの差異が依然として有意かを頑健な標準誤差ベースで判定します。
```{r}
library(estimatr)
#ミンサー方程式をOLSで重回帰
reg0 <- lm(lincome ~ yeduc, data = income6) 
#回帰の結果の確認
waldtest(reg0, reg1, vcov = vcov)
```

`lm_robust()` の `se_type = "stata"` を使えば推定時点でハブホワイト型の標準誤差を得られるため、外部で `vcovHC` を計算せずに済む方法も押さえておきます。
```{r}
library(estimatr)
#ミンサー方程式をOLSで重回帰
reg_lm <- lm_robust(lincome ~ yeduc + exper + exper2, data = income6,se_type="stata") 
#回帰の結果の確認
summary(reg_lm)
```

同じ関数で `se_type = "classical"` を指定すると通常のOLS標準誤差に切り替えられるので、ロバスト推定との数値差を直接比較できます（ここでは `summary(reg_lm)` と見比べます）。
```{r}
reg_0 <- lm_robust(lincome ~ yeduc + exper + exper2, data = income6,se_type="classical") 
#回帰の結果の確認
summary(reg_lm)
```

最後にロバスト推定同士 (`reg_lm0` vs `reg_lm`) を `waldtest(..., test = "F")` で比較し、頑健な分散を前提に制約付きモデルが棄却されるかを確認します。
```{r}
reg_lm0 <- lm_robust(lincome ~ yeduc, data = income6, se_type="stata") 
#回帰の結果の確認

waldtest(reg_lm0,reg_lm,test = "F")
```
